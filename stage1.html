<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Stage 1 : Puzzle</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <h1 class="title">Stage 1 : Puzzle 3x3</h1>
  <div id="puzzle-board" class="puzzle-board"></div>
  <div id="score-panel">Coups : <span id="moves">0</span></div>
  <div id="ad-space">
    <img src="files/ad.jpg" alt="PublicitÃ©" />
    <p>Visitez notre ferme bio !</p>
  </div>

  <script>
    const board = document.getElementById("puzzle-board");
    const movesCounter = document.getElementById("moves");
    let moves = 0;
    const gridSize = 3;
    const totalPieces = gridSize * gridSize;
    const pieceSize = 100; // taille d'un morceau

    const positions = Array.from({ length: totalPieces }, (_, i) => i);
    const shuffled = [...positions].sort(() => Math.random() - 0.5);

    function createPiece(index, targetIndex) {
      const piece = document.createElement("div");
      piece.className = "piece";
      piece.style.width = `${pieceSize}px`;
      piece.style.height = `${pieceSize}px`;
      piece.style.backgroundImage = "url('files/cat.jpg')";
      piece.style.backgroundSize = `${gridSize * pieceSize}px`;
      piece.style.backgroundPosition = `-${(targetIndex % gridSize) * pieceSize}px -${Math.floor(targetIndex / gridSize) * pieceSize}px`;
      piece.dataset.correct = targetIndex;
      board.appendChild(piece);
    }

    shuffled.forEach((targetIndex, i) => {
      createPiece(i, targetIndex);
    });

    let selected = null;

    board.addEventListener("click", (e) => {
      if (!e.target.classList.contains("piece")) return;
      if (!selected) {
        selected = e.target;
        selected.classList.add("selected");
      } else if (selected !== e.target) {
        swapPieces(selected, e.target);
        selected.classList.remove("selected");
        selected = null;
        moves++;
        movesCounter.textContent = moves;
        checkWin();
      }
    });

    function swapPieces(a, b) {
      const tempPos = a.style.backgroundPosition;
      a.style.backgroundPosition = b.style.backgroundPosition;
      b.style.backgroundPosition = tempPos;
    }

    function checkWin() {
      const pieces = Array.from(board.children);
      const isCorrect = pieces.every((p, i) => {
        const x = (p.dataset.correct % gridSize) * pieceSize;
        const y = Math.floor(p.dataset.correct / gridSize) * pieceSize;
        return p.style.backgroundPosition === `-${x}px -${y}px`;
      });

      if (isCorrect) {
        showCompletedImage();
      }
    }

    function showCompletedImage() {
      const img = document.createElement("div");
      img.className = "full-image";
      img.style.backgroundImage = "url('files/cat.jpg')";
      img.style.transform = "scale(1.2)";
      document.body.appendChild(img);

      setTimeout(() => {
        img.classList.add("show");
      }, 100);

      setTimeout(() => {
        alert("ðŸŽ‰ Bien complÃ©tÃ© ! Vous passez au Stage 2.");
        window.location.href = "stage2.html";
      }, 2200);
    }
  </script>
</body>
</html>
