<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Stage 1 : Puzzle</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <h1 class="title">Stage 1 : Puzzle 4x4</h1>
  <div id="puzzle-board" class="puzzle-board"></div>
  <div id="score-panel">Coups : <span id="moves">0</span></div>
  <div id="ad-space">
    <img src="files/ad.jpg" alt="Publicité" />
    <p>Visitez notre ferme bio !</p>
  </div>

  <script>
    const board = document.getElementById("puzzle-board");
    const movesCounter = document.getElementById("moves");
    let moves = 0;
    const gridSize = 4;
    const totalPieces = gridSize * gridSize;
    const pieces = Array.from({ length: totalPieces }, (_, i) => i);
    const correctOrder = [...pieces];
    pieces.sort(() => Math.random() - 0.5);

    function createPiece(index, position) {
      const piece = document.createElement("div");
      piece.className = "piece";
      piece.style.backgroundImage = "url('files/cat.jpg')";
      const size = 100;
      const x = (position % gridSize) * -size;
      const y = Math.floor(position / gridSize) * -size;
      piece.style.backgroundPosition = `${x}px ${y}px`;
      piece.dataset.index = index;
      board.appendChild(piece);
    }

    pieces.forEach((pos, i) => createPiece(i, pos));

    let selected = null;

    board.addEventListener("click", (e) => {
      if (!e.target.classList.contains("piece")) return;
      if (selected === null) {
        selected = e.target;
        selected.classList.add("selected");
      } else if (selected !== e.target) {
        swapPieces(selected, e.target);
        selected.classList.remove("selected");
        selected = null;
        moves++;
        movesCounter.textContent = moves;
        checkWin();
      }
    });

    function swapPieces(a, b) {
      const temp = a.style.backgroundPosition;
      a.style.backgroundPosition = b.style.backgroundPosition;
      b.style.backgroundPosition = temp;
    }

    function checkWin() {
      const current = Array.from(board.children).map(p => p.style.backgroundPosition);
      const win = [];
      for (let i = 0; i < totalPieces; i++) {
        const size = 100;
        const x = (i % gridSize) * -size;
        const y = Math.floor(i / gridSize) * -size;
        win.push(`${x}px ${y}px`);
      }
      if (JSON.stringify(current) === JSON.stringify(win)) {
        showCompletedImage();
      }
    }

    function showCompletedImage() {
      const img = document.createElement("div");
      img.className = "full-image";
      img.style.backgroundImage = "url('files/cat.jpg')";
      document.body.appendChild(img);

      setTimeout(() => {
        img.classList.add("show");
      }, 100);

      setTimeout(() => {
        alert("?? Bien complété ! Vous passez au Stage 2.");
        window.location.href = "stage2.html";
      }, 2200);
    }
  </script>
</body>
</html>